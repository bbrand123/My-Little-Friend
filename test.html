<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pet Care Test</title>
    <link rel="icon" href="data:,">
</head>
<body>
    <h1>Testing Game Load</h1>
    <div id="test-results"></div>

    <!-- Minimal DOM structure required by game/UI scripts -->
    <div id="game-content" style="display:none"></div>
    <div id="toast-container" style="display:none"></div>
    <div id="live-announcer" aria-live="polite" style="display:none"></div>
    <div id="live-announcer-assertive" aria-live="assertive" aria-atomic="true" style="display:none"></div>

    <script src="js/constants.js"></script>
    <script src="js/svg.js"></script>
    <script src="js/balance.js"></script>
    <script src="js/sound.js"></script>
    <script src="js/game.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/minigames.js"></script>
    <script src="js/competition.js"></script>
    <script>
        const results = document.getElementById('test-results');
        let _testsFailed = false;

        function log(message, success = true) {
            if (!success) _testsFailed = true;
            const p = document.createElement('p');
            p.textContent = (success ? '‚úÖ ' : '‚ùå ') + message;
            p.style.color = success ? 'green' : 'red';
            results.appendChild(p);
        }

        // Save existing game data before tests and restore after
        const _savedGameData = localStorage.getItem('petCareBuddy');

        try {
            // Test 1: Constants loaded
            if (typeof GROWTH_STAGES !== 'undefined') {
                log('GROWTH_STAGES loaded');
            } else {
                log('GROWTH_STAGES not found', false);
            }

            // Test 2: Care quality constants
            if (typeof CARE_QUALITY !== 'undefined') {
                log('CARE_QUALITY loaded');
                log(`Care quality levels: ${Object.keys(CARE_QUALITY).join(', ')}`);
            } else {
                log('CARE_QUALITY not found', false);
            }

            // Test 3: Evolution data
            if (typeof PET_EVOLUTIONS !== 'undefined') {
                log('PET_EVOLUTIONS loaded');
                log(`Evolution count: ${Object.keys(PET_EVOLUTIONS).length}`);
            } else {
                log('PET_EVOLUTIONS not found', false);
            }

            // Test 4: Birthday rewards
            if (typeof BIRTHDAY_REWARDS !== 'undefined') {
                log('BIRTHDAY_REWARDS loaded');
            } else {
                log('BIRTHDAY_REWARDS not found', false);
            }

            // Test 5: Growth stages timing
            if (typeof GROWTH_STAGES !== 'undefined' && GROWTH_STAGES.child && GROWTH_STAGES.adult) {
                log(`Baby‚ÜíChild: ${GROWTH_STAGES.child.hoursNeeded} hours, ${GROWTH_STAGES.child.actionsNeeded} actions`);
                log(`Child‚ÜíAdult: ${GROWTH_STAGES.adult.hoursNeeded} hours, ${GROWTH_STAGES.adult.actionsNeeded} actions`);
            } else {
                log('GROWTH_STAGES.child or .adult missing', false);
            }

            // Test 6: Functions exist
            if (typeof getGrowthStage === 'function') {
                log('getGrowthStage() function available');

                // Test growth stage calculation
                const stage1 = getGrowthStage(0, 0);
                const stage2 = getGrowthStage(20, 3);
                const stage3 = getGrowthStage(50, 10);

                log(`getGrowthStage(0, 0) = ${stage1} (expected: baby)`, stage1 === 'baby');
                log(`getGrowthStage(20, 3) = ${stage2} (expected: child)`, stage2 === 'child');
                log(`getGrowthStage(50, 10) = ${stage3} (expected: adult)`, stage3 === 'adult');
            } else {
                log('getGrowthStage() not found', false);
            }

            // Test 7: Care quality function
            if (typeof getCareQuality === 'function') {
                log('getCareQuality() function available');

                const quality1 = getCareQuality(30, 0);
                const quality2 = getCareQuality(65, 3);
                const quality3 = getCareQuality(85, 1);

                log(`getCareQuality(30, 0) = ${quality1} (expected: poor)`, quality1 === 'poor');
                log(`getCareQuality(65, 3) = ${quality2} (expected: good)`, quality2 === 'good');
                log(`getCareQuality(85, 1) = ${quality3} (expected: excellent)`, quality3 === 'excellent');
            } else {
                log('getCareQuality() not found', false);
            }

            // Test 8: SVG functions
            if (typeof applyCareVariant === 'function') {
                log('applyCareVariant() function available');

                const testColor = '#FF0000';
                const dull = applyCareVariant(testColor, 'dull');
                const shiny = applyCareVariant(testColor, 'shiny');

                const dullValid = typeof dull === 'string' && dull !== testColor;
                const shinyValid = typeof shiny === 'string' && shiny !== testColor;
                log(`Color transformation works: dull=${dull}, shiny=${shiny}`, dullValid && shinyValid);
            } else {
                log('applyCareVariant() not found', false);
            }

            // Test 9: Sound manager loaded
            if (typeof SoundManager !== 'undefined') {
                log('SoundManager loaded');
                const hasSFX = typeof SoundManager.playSFX === 'function';
                log(`SoundManager has playSFX: ${hasSFX}`, hasSFX);
            } else {
                log('SoundManager not found', false);
            }

            // Test 10: Game logic functions (game.js)
            if (typeof escapeHTML === 'function') {
                log('escapeHTML() function available');
                const escaped = escapeHTML('<b>test & "quote"</b>');
                const correct = escaped.includes('&lt;') && escaped.includes('&amp;');
                log(`escapeHTML escapes correctly: ${correct}`, correct);
            } else {
                log('escapeHTML() not found', false);
            }

            if (typeof saveGame === 'function') {
                log('saveGame() function available');
            } else {
                log('saveGame() not found', false);
            }

            if (typeof loadGame === 'function') {
                log('loadGame() function available');
            } else {
                log('loadGame() not found', false);
            }

            // Test 11: Relationship level functions (constants.js)
            if (typeof getRelationshipLevel === 'function') {
                log('getRelationshipLevel() function available');
                const rel0 = getRelationshipLevel(0);
                const rel50 = getRelationshipLevel(50);
                const rel250 = getRelationshipLevel(250);
                log(`getRelationshipLevel(0) = ${rel0} (expected: stranger)`, rel0 === 'stranger');
                log(`getRelationshipLevel(50) = ${rel50} (expected: friend)`, rel50 === 'friend');
                log(`getRelationshipLevel(250) = ${rel250} (expected: family)`, rel250 === 'family');
            } else {
                log('getRelationshipLevel() not found', false);
            }

            // Test 12: UI functions (ui.js)
            if (typeof showToast === 'function') {
                log('showToast() function available');
            } else {
                log('showToast() not found', false);
            }

            if (typeof renderPetPhase === 'function') {
                log('renderPetPhase() function available');
            } else {
                log('renderPetPhase() not found', false);
            }

            // Test 13: Minigame functions (minigames.js)
            if (typeof generateHideSeekPositions === 'function') {
                log('generateHideSeekPositions() function available');
                const positions = generateHideSeekPositions(6);
                log(`Generated ${positions.length} hide-seek positions (expected: 6)`, positions.length === 6);
                // Verify no positions are nearly identical (overlap check)
                let hasOverlap = false;
                for (let i = 0; i < positions.length; i++) {
                    for (let j = i + 1; j < positions.length; j++) {
                        const dist = Math.hypot(positions[i].x - positions[j].x, positions[i].y - positions[j].y);
                        if (dist < 1) { hasOverlap = true; break; }
                    }
                    if (hasOverlap) break;
                }
                log(`No overlapping positions: ${!hasOverlap}`, !hasOverlap);
            } else {
                log('generateHideSeekPositions() not found', false);
            }

            // Test 14: CARE_QUALITY_ORDER constant
            if (typeof CARE_QUALITY_ORDER !== 'undefined') {
                log('CARE_QUALITY_ORDER loaded');
                const expected = ['excellent', 'good', 'average', 'poor'];
                const matches = JSON.stringify(CARE_QUALITY_ORDER) === JSON.stringify(expected);
                log(`CARE_QUALITY_ORDER is best-to-worst: ${matches}`, matches);
            } else {
                log('CARE_QUALITY_ORDER not found', false);
            }

            // Test 15: getGrowthProgress function
            if (typeof getGrowthProgress === 'function') {
                log('getGrowthProgress() function available');
                const progress1 = getGrowthProgress(0, 0, 'baby');
                const progress2 = getGrowthProgress(50, 10, 'adult');
                log(`getGrowthProgress(0, 0, 'baby') = ${progress1} (should be 0)`, progress1 === 0);
                log(`getGrowthProgress(50, 10, 'adult') = ${progress2} (should be 20)`, progress2 === 20);
            } else {
                log('getGrowthProgress() not found', false);
            }

            // Test 16: getNextGrowthStage function
            if (typeof getNextGrowthStage === 'function') {
                log('getNextGrowthStage() function available');
                const next1 = getNextGrowthStage('baby');
                const next2 = getNextGrowthStage('adult');
                const next3 = getNextGrowthStage('invalid');
                log(`getNextGrowthStage('baby') = ${next1} (expected: child)`, next1 === 'child');
                log(`getNextGrowthStage('adult') = ${next2} (expected: elder)`, next2 === 'elder');
                log(`getNextGrowthStage('invalid') = ${next3} (expected: null)`, next3 === null);
            } else {
                log('getNextGrowthStage() not found', false);
            }

            // Test 17: getRelationshipProgress function
            if (typeof getRelationshipProgress === 'function') {
                log('getRelationshipProgress() function available');
                const rp = getRelationshipProgress(0);
                log(`getRelationshipProgress(0) is a number`, typeof rp === 'number');
            } else {
                log('getRelationshipProgress() not found', false);
            }

            // Test 18: getStreakBonus function
            if (typeof getStreakBonus === 'function') {
                log('getStreakBonus() function available');
                const sb = getStreakBonus(0);
                log(`getStreakBonus(0) returns object`, sb !== null && typeof sb === 'object');
            } else {
                log('getStreakBonus() not found', false);
            }

            // Test 19: getUnlockedPlotCount function
            if (typeof getUnlockedPlotCount === 'function') {
                log('getUnlockedPlotCount() function available');
                const plots = getUnlockedPlotCount(0);
                log(`getUnlockedPlotCount(0) is a number`, typeof plots === 'number');
            } else {
                log('getUnlockedPlotCount() not found', false);
            }

            // Test 20: getCurrentSeason function
            if (typeof getCurrentSeason === 'function') {
                log('getCurrentSeason() function available');
                const season = getCurrentSeason();
                const validSeasons = ['spring', 'summer', 'autumn', 'winter'];
                log(`getCurrentSeason() = ${season} (valid season)`, validSeasons.includes(season));
            } else {
                log('getCurrentSeason() not found', false);
            }

            // Test 21: shuffleArray function
            if (typeof shuffleArray === 'function') {
                log('shuffleArray() function available');
                const arr = [1, 2, 3, 4, 5];
                const shuffled = shuffleArray([...arr]);
                log(`shuffleArray returns same length`, shuffled.length === arr.length);
                log(`shuffleArray preserves elements`, arr.every(v => shuffled.includes(v)));
            } else {
                log('shuffleArray() not found', false);
            }

            if (!_testsFailed) {
                log('\nüéâ All basic tests passed!', true);
            } else {
                log('\n‚ö†Ô∏è Some tests failed. See above for details.', false);
            }

        } catch (error) {
            log(`Error during testing: ${error.message}`, false);
            console.error(error);
        } finally {
            // Restore game data to avoid test pollution
            if (_savedGameData !== null) {
                localStorage.setItem('petCareBuddy', _savedGameData);
            } else {
                localStorage.removeItem('petCareBuddy');
            }
        }
    </script>
</body>
</html>
